name: LinkOps CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"
  # Version strategy: YYYYMMDD-commit_hash (e.g., 20250714-a1b2c3d)
  IMAGE_TAG: "${{ github.event_name == 'push' && format('{0}-{1}', github.run_number, github.sha) || 'latest' }}"

permissions:
  contents: write  # For ArgoCD updates
  security-events: write  # For potential Trivy uploads

jobs:
  lint-python:
    runs-on: ubuntu-latest
    name: Python Lint + Format Check
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python Tools
        run: pip install ruff bandit isort

      - name: Check Black Formatting
        run: |
          echo "ðŸŽ¨ Checking Python formatting..."
          ruff format --check mlops/ shadows/ || {
            echo "âŒ Black formatting issues found"
            echo "âš ï¸ Continuing despite formatting issues"
          }
        continue-on-error: true

      - name: Check isort Imports
        run: |
          echo "ðŸ“¦ Checking Python imports..."
          isort --check-only --diff mlops/ shadows/ || {
            echo "âŒ isort issues found"
            echo "âš ï¸ Continuing despite import issues"
          }
        continue-on-error: true

      - name: Run Ruff Linting
        run: |
          echo "ðŸ” Running Ruff linting..."
          ruff check --ignore E402 mlops/ shadows/ || {
            echo "âŒ Ruff linting errors found"
            echo "âš ï¸ Continuing despite linting issues"
          }
        continue-on-error: true

      - name: Run Bandit Security Scan
        run: |
          echo "ðŸ”’ Running security scan..."
          bandit -r mlops/ shadows/ -f json || echo "âš ï¸ Security issues found but continuing"
        continue-on-error: true

  lint-frontend:
    runs-on: ubuntu-latest
    name: Frontend Lint + Format Check
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install Frontend Dependencies
        run: |
          cd frontend
          npm ci
        continue-on-error: true

      - name: Check Prettier Formatting
        run: |
          cd frontend
          echo "ðŸŽ¨ Checking frontend formatting..."
          npx prettier --check . || {
            echo "âŒ Prettier formatting issues found"
            echo "âš ï¸ Continuing despite formatting issues"
          }
        continue-on-error: true

      - name: Run ESLint
        run: |
          cd frontend
          echo "ðŸ” Running ESLint..."
          npx eslint . || {
            echo "âŒ ESLint errors found"
            echo "âš ï¸ Continuing despite linting issues"
          }
        continue-on-error: true

  lint-yaml:
    runs-on: ubuntu-latest
    name: YAML Lint + Format Check
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Prettier
        run: npm install --global prettier

      - name: Install yamllint
        run: pip install yamllint

      - name: Check Prettier Formatting (YAML)
        run: |
          echo "ðŸŽ¨ Checking YAML formatting..."
          prettier --check "helm/argocd/**/*.yaml" "helm/linkops/values.yaml" "helm/linkops/Chart.yaml" \
            ".github/**/*.yml" || {
            echo "âŒ YAML formatting issues found"
            echo "âš ï¸ Continuing despite YAML formatting issues"
          }
        continue-on-error: true

      - name: Run yamllint
        run: |
          echo "ðŸ” Running YAML linting..."
          yamllint helm/ .github/ || {
            echo "âŒ YAML linting errors found"
            echo "âš ï¸ Continuing despite YAML linting issues"
          }
        continue-on-error: true

  helm-validate:
    runs-on: ubuntu-latest
    name: Helm Chart Lint
    needs: [lint-yaml]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - uses: azure/setup-helm@v3
        with:
          version: v3.12.0

      - name: Helm Validation
        run: |
          cd helm/linkops
          echo "ðŸ“¦ Updating Helm dependencies..."
          helm dependency update || {
            echo "âš ï¸ Dependency update failed - trying without cache"
            rm -rf charts/ Chart.lock
            helm dependency update || echo "Dependencies may be outdated"
          }
          echo "ðŸ” Linting Helm charts..."
          helm lint . || echo "âš ï¸ Helm lint issues found but continuing"
        continue-on-error: true

  trivy-scan:
    runs-on: ubuntu-latest
    name: "ðŸ” Trivy Security Scan"
    needs: [lint-python, lint-frontend, lint-yaml]
    if: always()
    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "ðŸ³ Scan Dockerfiles, IaC, and Code"
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          format: table
          exit-code: 0  # Continue on vulnerabilities for now
          ignore-unfixed: true
          severity: CRITICAL,HIGH

      - name: "ðŸ“Š Generate Trivy Report"
        run: |
          echo "ðŸ“‹ Trivy scan completed"
          echo "ðŸ” Scanned for:"
          echo "  - CVEs in Dockerfiles"
          echo "  - Misconfigurations in Terraform, YAML"
          echo "  - Basic secret detection"
          echo "  - Infrastructure as Code issues"
        continue-on-error: true

  gitguardian-secrets-scan:
    runs-on: ubuntu-latest
    name: "ðŸ›¡ GitGuardian Secret Scan"
    needs: [lint-python, lint-frontend, lint-yaml]
    if: always() && github.event_name == 'push'
    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better secret detection

      - name: "ðŸ›¡ Scan with GitGuardian"
        uses: GitGuardian/ggshield-action@v1.20.0
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
        with:
          args: scan repo .
        continue-on-error: true

      - name: "ðŸ“Š GitGuardian Report Summary"
        run: |
          echo "ðŸ›¡ï¸ GitGuardian secret scan completed"
          echo "ðŸ” Advanced secret detection performed"
          echo "ðŸ“‹ Check GitGuardian dashboard for detailed results"
        continue-on-error: true

  security-summary:
    runs-on: ubuntu-latest
    name: "ðŸ“Š Security Scan Summary"
    needs: [trivy-scan, gitguardian-secrets-scan]
    if: always()
    steps:
      - name: "ðŸ“‹ Generate Security Summary"
        run: |
          echo "ðŸ”’ LinkOps Security Scan Summary"
          echo "=================================="
          echo ""
          echo "âœ… Trivy Scan: ${{ needs.trivy-scan.result }}"
          echo "âœ… GitGuardian Scan: ${{ needs.gitguardian-secrets-scan.result }}"
          echo ""
          echo "ðŸ” Security Coverage:"
          echo "  - Container vulnerabilities (Trivy)"
          echo "  - Infrastructure misconfigurations (Trivy)"
          echo "  - Advanced secret detection (GitGuardian)"
          echo "  - Code security issues (Trivy)"
          echo ""
          echo "ðŸ“Š Next Steps:"
          echo "  - Review Trivy results for critical/high vulnerabilities"
          echo "  - Check GitGuardian dashboard for secret alerts"
          echo "  - Address any security findings before deployment"
          echo ""
          if [[ "${{ needs.trivy-scan.result }}" == "failure" ]] || [[ "${{ needs.gitguardian-secrets-scan.result }}" == "failure" ]]; then
            echo "âš ï¸ Security scans completed with issues - review required"
            exit 0  # Don't fail the pipeline, but flag for review
          else
            echo "âœ… All security scans completed successfully"
          fi
        continue-on-error: true

  docker-build-push:
    runs-on: ubuntu-latest
    name: "Build + Push Demo Docker Images"
    needs:
      [
        lint-python,
        lint-frontend,
        lint-yaml,
        trivy-scan,
        gitguardian-secrets-scan,
        security-summary,
      ]
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Debug - List Demo Services
        run: |
          echo "ðŸ” Demo Services Check..."
          echo "Current directory: $(pwd)"
          echo ""
          echo "Demo services to build:"
          echo "âœ… frontend/ (Vue.js frontend)"
          echo "âœ… mlops/mlops-platform/ (Main API orchestration)"
          echo "âœ… mlops/whis-data-input/ (Data input service)"
          echo "âœ… mlops/whis-sanitize/ (Data sanitization service)"
          echo "âœ… mlops/whis-logic/ (ML logic service)"
          echo "âœ… shadows/ficknury-evaluator/ (Task evaluation service)"
          echo ""
          echo "Checking Dockerfiles exist:"
          for service in frontend mlops/mlops-platform mlops/whis-data-input mlops/whis-sanitize mlops/whis-logic shadows/ficknury-evaluator; do
            if [[ -f "$service/Dockerfile" ]]; then
              echo "âœ… $service/Dockerfile exists"
            else
              echo "âŒ $service/Dockerfile missing"
            fi
          done

      - name: Validate Docker Registry Secrets
        run: |
          echo "ðŸ” Validating Docker registry configuration..."
          if [[ -z "${{ secrets.DOCKER_USER }}" ]]; then
            echo "âŒ DOCKER_USER secret is not set"
            exit 1
          fi
          if [[ -z "${{ secrets.DOCKER_CRED }}" ]]; then
            echo "âŒ DOCKER_CRED secret is not set"
            exit 1
          fi
          echo "âœ… Docker secrets are configured"

      - name: Docker Registry Login
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_CRED }}

      # Build and push each demo service
      - name: Build + Push Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: true
          tags: linksrobot/demo-frontend:${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build + Push MLOps Platform
        uses: docker/build-push-action@v4
        with:
          context: ./mlops/mlops-platform
          push: true
          tags: linksrobot/demo-mlops-platform:${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build + Push Whis Data Input
        uses: docker/build-push-action@v4
        with:
          context: ./mlops/whis-data-input
          push: true
          tags: linksrobot/demo-whis-data-input:${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build + Push Whis Sanitize
        uses: docker/build-push-action@v4
        with:
          context: ./mlops/whis-sanitize
          push: true
          tags: linksrobot/demo-whis-sanitize:${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build + Push Whis Logic
        uses: docker/build-push-action@v4
        with:
          context: ./mlops/whis-logic
          push: true
          tags: linksrobot/demo-whis-logic:${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build + Push Ficknury Evaluator
        uses: docker/build-push-action@v4
        with:
          context: ./shadows/ficknury-evaluator
          push: true
          tags: linksrobot/demo-ficknury-evaluator:${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Summary
        run: |
          echo "ðŸŽ‰ Demo Docker Build Complete!"
          echo "=================================="
          echo ""
          echo "âœ… Successfully built and pushed:"
          echo "  - linksrobot/demo-frontend:${{ env.IMAGE_TAG }}"
          echo "  - linksrobot/demo-mlops-platform:${{ env.IMAGE_TAG }}"
          echo "  - linksrobot/demo-whis-data-input:${{ env.IMAGE_TAG }}"
          echo "  - linksrobot/demo-whis-sanitize:${{ env.IMAGE_TAG }}"
          echo "  - linksrobot/demo-whis-logic:${{ env.IMAGE_TAG }}"
          echo "  - linksrobot/demo-ficknury-evaluator:${{ env.IMAGE_TAG }}"
          echo ""
          echo "ðŸš€ Ready for deployment on Azure VM!"
          echo "Run: docker-compose pull && docker-compose up -d"

      - name: Create Version File
        run: |
          echo "ðŸ“ Creating version file for deployment tracking..."
          cat > VERSION << EOF
          # LinkOps Demo Version
          # Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          # Commit: ${{ github.sha }}
          # Run: ${{ github.run_number }}
          
          IMAGE_TAG=${{ env.IMAGE_TAG }}
          
          # Service Images
          FRONTEND_IMAGE=linksrobot/demo-frontend:${{ env.IMAGE_TAG }}
          MLOPS_PLATFORM_IMAGE=linksrobot/demo-mlops-platform:${{ env.IMAGE_TAG }}
          WHIS_DATA_INPUT_IMAGE=linksrobot/demo-whis-data-input:${{ env.IMAGE_TAG }}
          WHIS_SANITIZE_IMAGE=linksrobot/demo-whis-sanitize:${{ env.IMAGE_TAG }}
          WHIS_LOGIC_IMAGE=linksrobot/demo-whis-logic:${{ env.IMAGE_TAG }}
          FICKNURY_EVALUATOR_IMAGE=linksrobot/demo-ficknury-evaluator:${{ env.IMAGE_TAG }}
          
          # Docker Compose Command
          # docker-compose pull && docker-compose up -d
          EOF
          
          echo "âœ… Version file created:"
          cat VERSION

      - name: Commit Version File
        if: github.event_name == 'push'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          git add VERSION
          git commit -m "chore: update version to ${{ env.IMAGE_TAG }} - $(date -u +"%Y-%m-%d %H:%M:%S")" || echo "No changes to commit"
          git push || echo "No push needed"

  update-argocd:
    runs-on: ubuntu-latest
    name: "Update ArgoCD Pull Config"
    needs: [docker-build-push]
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update ArgoCD sync trigger
        run: |
          if [[ -f "helm/argocd/application.yaml" ]]; then
            echo "# Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> helm/argocd/application.yaml
            git config user.name "github-actions[bot]"
            git config user.email "actions@github.com"
            git add helm/argocd/application.yaml
            git commit -m "chore: trigger ArgoCD sync - $(date -u +"%Y-%m-%d %H:%M:%S")" || echo "No changes to commit"
            git push || echo "No push needed"
          else
            echo "ArgoCD application.yaml not found, skipping sync trigger"
          fi
        continue-on-error: true

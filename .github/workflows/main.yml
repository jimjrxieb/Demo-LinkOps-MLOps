name: LinkOps CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"

permissions:
  contents: write  # For ArgoCD updates
  security-events: write  # For potential Trivy uploads

jobs:
  lint-python:
    runs-on: ubuntu-latest
    name: Python Lint + Format Check
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python Tools
        run: pip install ruff bandit isort

      - name: Check Black Formatting
        run: |
          echo "ðŸŽ¨ Checking Python formatting..."
          ruff format --check mlops/ shadows/ || {
            echo "âŒ Black formatting issues found"
            echo "âš ï¸ Continuing despite formatting issues"
          }
        continue-on-error: true

      - name: Check isort Imports
        run: |
          echo "ðŸ“¦ Checking Python imports..."
          isort --check-only --diff mlops/ shadows/ || {
            echo "âŒ isort issues found"
            echo "âš ï¸ Continuing despite import issues"
          }
        continue-on-error: true

      - name: Run Ruff Linting
        run: |
          echo "ðŸ” Running Ruff linting..."
          ruff check --ignore E402 mlops/ shadows/ || {
            echo "âŒ Ruff linting errors found"
            echo "âš ï¸ Continuing despite linting issues"
          }
        continue-on-error: true

      - name: Run Bandit Security Scan
        run: |
          echo "ðŸ”’ Running security scan..."
          bandit -r mlops/ shadows/ -f json || echo "âš ï¸ Security issues found but continuing"
        continue-on-error: true

  lint-frontend:
    runs-on: ubuntu-latest
    name: Frontend Lint + Format Check
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install Frontend Dependencies
        run: |
          cd frontend
          npm ci
        continue-on-error: true

      - name: Check Prettier Formatting
        run: |
          cd frontend
          echo "ðŸŽ¨ Checking frontend formatting..."
          npx prettier --check . || {
            echo "âŒ Prettier formatting issues found"
            echo "âš ï¸ Continuing despite formatting issues"
          }
        continue-on-error: true

      - name: Run ESLint
        run: |
          cd frontend
          echo "ðŸ” Running ESLint..."
          npx eslint . || {
            echo "âŒ ESLint errors found"
            echo "âš ï¸ Continuing despite linting issues"
          }
        continue-on-error: true

  lint-yaml:
    runs-on: ubuntu-latest
    name: YAML Lint + Format Check
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Prettier
        run: npm install --global prettier

      - name: Install yamllint
        run: pip install yamllint

      - name: Check Prettier Formatting (YAML)
        run: |
          echo "ðŸŽ¨ Checking YAML formatting..."
          prettier --check "helm/argocd/**/*.yaml" "helm/linkops/values.yaml" "helm/linkops/Chart.yaml" \
            ".github/**/*.yml" || {
            echo "âŒ YAML formatting issues found"
            echo "âš ï¸ Continuing despite YAML formatting issues"
          }
        continue-on-error: true

      - name: Run yamllint
        run: |
          echo "ðŸ” Running YAML linting..."
          yamllint helm/ .github/ || {
            echo "âŒ YAML linting errors found"
            echo "âš ï¸ Continuing despite YAML linting issues"
          }
        continue-on-error: true

  helm-validate:
    runs-on: ubuntu-latest
    name: Helm Chart Lint
    needs: [lint-yaml]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - uses: azure/setup-helm@v3
        with:
          version: v3.12.0

      - name: Helm Validation
        run: |
          cd helm/linkops
          echo "ðŸ“¦ Updating Helm dependencies..."
          helm dependency update || {
            echo "âš ï¸ Dependency update failed - trying without cache"
            rm -rf charts/ Chart.lock
            helm dependency update || echo "Dependencies may be outdated"
          }
          echo "ðŸ” Linting Helm charts..."
          helm lint . || echo "âš ï¸ Helm lint issues found but continuing"
        continue-on-error: true

  trivy-scan:
    runs-on: ubuntu-latest
    name: "ðŸ” Trivy Security Scan"
    needs: [lint-python, lint-frontend, lint-yaml]
    if: always()
    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "ðŸ³ Scan Dockerfiles, IaC, and Code"
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          format: table
          exit-code: 0  # Continue on vulnerabilities for now
          ignore-unfixed: true
          severity: CRITICAL,HIGH

      - name: "ðŸ“Š Generate Trivy Report"
        run: |
          echo "ðŸ“‹ Trivy scan completed"
          echo "ðŸ” Scanned for:"
          echo "  - CVEs in Dockerfiles"
          echo "  - Misconfigurations in Terraform, YAML"
          echo "  - Basic secret detection"
          echo "  - Infrastructure as Code issues"
        continue-on-error: true

  gitguardian-secrets-scan:
    runs-on: ubuntu-latest
    name: "ðŸ›¡ GitGuardian Secret Scan"
    needs: [lint-python, lint-frontend, lint-yaml]
    if: always() && github.event_name == 'push'
    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better secret detection

      - name: "ðŸ›¡ Scan with GitGuardian"
        uses: GitGuardian/ggshield-action@v1.20.0
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
        with:
          args: scan repo .
        continue-on-error: true

      - name: "ðŸ“Š GitGuardian Report Summary"
        run: |
          echo "ðŸ›¡ï¸ GitGuardian secret scan completed"
          echo "ðŸ” Advanced secret detection performed"
          echo "ðŸ“‹ Check GitGuardian dashboard for detailed results"
        continue-on-error: true

  security-summary:
    runs-on: ubuntu-latest
    name: "ðŸ“Š Security Scan Summary"
    needs: [trivy-scan, gitguardian-secrets-scan]
    if: always()
    steps:
      - name: "ðŸ“‹ Generate Security Summary"
        run: |
          echo "ðŸ”’ LinkOps Security Scan Summary"
          echo "=================================="
          echo ""
          echo "âœ… Trivy Scan: ${{ needs.trivy-scan.result }}"
          echo "âœ… GitGuardian Scan: ${{ needs.gitguardian-secrets-scan.result }}"
          echo ""
          echo "ðŸ” Security Coverage:"
          echo "  - Container vulnerabilities (Trivy)"
          echo "  - Infrastructure misconfigurations (Trivy)"
          echo "  - Advanced secret detection (GitGuardian)"
          echo "  - Code security issues (Trivy)"
          echo ""
          echo "ðŸ“Š Next Steps:"
          echo "  - Review Trivy results for critical/high vulnerabilities"
          echo "  - Check GitGuardian dashboard for secret alerts"
          echo "  - Address any security findings before deployment"
          echo ""
          if [[ "${{ needs.trivy-scan.result }}" == "failure" ]] || [[ "${{ needs.gitguardian-secrets-scan.result }}" == "failure" ]]; then
            echo "âš ï¸ Security scans completed with issues - review required"
            exit 0  # Don't fail the pipeline, but flag for review
          else
            echo "âœ… All security scans completed successfully"
          fi
        continue-on-error: true

  docker-build-push:
    runs-on: ubuntu-latest
    name: "Build + Push Docker Images"
    needs:
      [
        lint-python,
        lint-frontend,
        lint-yaml,
        trivy-scan,
        gitguardian-secrets-scan,
        security-summary,
      ]
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Debug - List all Dockerfiles
        run: |
          echo "ðŸ” Searching for Dockerfiles..."
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la
          echo ""
          echo "mlops/ directory contents:"
          ls -la mlops/ || echo "mlops/ directory not found"
          echo ""
          echo "shadows/ directory contents:"
          ls -la shadows/ || echo "shadows/ directory not found"
          echo ""
          echo "All Dockerfiles found:"
          find . -name Dockerfile -type f 2>/dev/null || echo "No Dockerfiles found"
          echo ""
          echo "Expected Docker build targets:"
          for dir in mlops/* shadows/*; do
            if [[ -d "$dir" ]]; then
              if [[ -f "$dir/Dockerfile" ]]; then
                echo "âœ… $dir (has Dockerfile)"
              else
                echo "âŒ $dir (missing Dockerfile)"
              fi
            fi
          done

      - name: Validate Docker Registry Secrets
        run: |
          echo "ðŸ” Validating Docker registry configuration..."
          if [[ -z "${{ secrets.DOCKER_USER }}" ]]; then
            echo "âŒ DOCKER_USER secret is not set"
            exit 1
          fi
          if [[ -z "${{ secrets.DOCKER_CRED }}" ]]; then
            echo "âŒ DOCKER_CRED secret is not set"
            exit 1
          fi
          echo "âœ… Docker secrets are configured"

      - name: Docker Registry Login
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_CRED }}

      - name: Build + Push all services
        run: |
          success_count=0
          total_count=0
          failed_services=()
          skipped_services=()

          echo "ðŸ—ï¸ Starting Docker build and push..."
          echo "ðŸ” Scanning for services with Dockerfiles..."
          
          # First, let's see what we're working with
          for dir in mlops/* shadows/*; do
            if [[ -d "$dir" ]]; then
              name=$(basename $dir)
              if [[ -f "$dir/Dockerfile" ]]; then
                echo "ðŸ“¦ Found service: $name (in $dir)"
                total_count=$((total_count + 1))
              else
                echo "â­ï¸ Skipping $name (no Dockerfile in $dir)"
                skipped_services+=("$name")
              fi
            fi
          done
          
          echo ""
          echo "ðŸ“Š Build Summary:"
          echo "Total services found: $total_count"
          echo "Services to skip: ${#skipped_services[@]}"
          echo ""
          
          if [[ $total_count -eq 0 ]]; then
            echo "âŒ No services with Dockerfiles found!"
            echo "Skipped services: ${skipped_services[*]}"
            exit 1
          fi
          
          # Now build each service
          for dir in mlops/* shadows/*; do
            if [[ -d "$dir" ]] && [[ -f "$dir/Dockerfile" ]]; then
              name=$(basename $dir)
              image_name="linksrobot/$name:latest"
              
              echo ""
              echo "ðŸ”¨ Building service: $name"
              echo "ðŸ“ Directory: $dir"
              echo "ðŸ³ Image: $image_name"
              echo "ðŸ“‹ Dockerfile contents:"
              head -5 "$dir/Dockerfile"
              echo "..."
              
              # Check if requirements.txt exists
              if [[ -f "$dir/requirements.txt" ]]; then
                echo "âœ… requirements.txt found"
              else
                echo "âš ï¸ No requirements.txt found"
              fi
              
              # Check if main.py exists
              if [[ -f "$dir/main.py" ]]; then
                echo "âœ… main.py found"
              else
                echo "âš ï¸ No main.py found"
              fi
              
              echo "ðŸš€ Starting build..."
              if docker build -t "$image_name" "$dir" --progress=plain --no-cache; then
                echo "âœ… Build successful for $name"
                echo "ðŸš€ Starting push..."
                if docker push "$image_name"; then
                  echo "âœ… Push successful for $name"
                  success_count=$((success_count + 1))
                else
                  echo "âŒ Push failed for $name"
                  failed_services+=("$name")
                fi
              else
                echo "âŒ Build failed for $name"
                failed_services+=("$name")
              fi
            fi
          done

          echo ""
          echo "ðŸ“Š Final Build and Push Summary:"
          echo "âœ… Successful: $success_count/$total_count services"
          echo "âŒ Failed: ${#failed_services[@]} services"
          echo "â­ï¸ Skipped: ${#skipped_services[@]} services"
          
          if [[ ${#failed_services[@]} -gt 0 ]]; then
            echo "Failed services:"
            for service in "${failed_services[@]}"; do
              echo "  - $service"
            done
          fi
          
          if [[ ${#skipped_services[@]} -gt 0 ]]; then
            echo "Skipped services (no Dockerfile):"
            for service in "${skipped_services[@]}"; do
              echo "  - $service"
            done
          fi

          if [[ $success_count -gt 0 ]] && [[ $((success_count * 10)) -ge $((total_count * 7)) ]]; then
            echo "âœ… Build pipeline successful (â‰¥70% services deployed)"
          else
            echo "âŒ Build pipeline failed (insufficient successful deployments)"
            echo "Success rate: $((success_count * 100 / total_count))%"
            exit 1
          fi

  update-argocd:
    runs-on: ubuntu-latest
    name: "Update ArgoCD Pull Config"
    needs: [docker-build-push]
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update ArgoCD sync trigger
        run: |
          if [[ -f "helm/argocd/application.yaml" ]]; then
            echo "# Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> helm/argocd/application.yaml
            git config user.name "github-actions[bot]"
            git config user.email "actions@github.com"
            git add helm/argocd/application.yaml
            git commit -m "chore: trigger ArgoCD sync - $(date -u +"%Y-%m-%d %H:%M:%S")" || echo "No changes to commit"
            git push || echo "No push needed"
          else
            echo "ArgoCD application.yaml not found, skipping sync trigger"
          fi
        continue-on-error: true

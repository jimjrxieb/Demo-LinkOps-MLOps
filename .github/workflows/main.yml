name: LinkOps Security + Helm CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

permissions:
  contents: read
  security-events: write

jobs:
  lint-python:
    runs-on: ubuntu-latest
    name: Python Lint + Bandit
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v4
    with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Auto-fix Python issues
    run: |
        pip install flake8 black bandit autoflake autopep8
        # Try auto-fixing common issues first
        python3 fix_flake8.py || echo "Auto-fix completed with warnings"
      continue-on-error: true

    - name: Python Code Quality Check
    run: |
        echo "ðŸ” Running Python linting..."
        flake8 mlops/ shadows/ --count --select=E9,F63,F7,F82 --show-source --statistics || {
          echo "âŒ Critical Python errors found"
          flake8 mlops/ shadows/ --count --show-source --statistics
          exit 1
        }

        echo "ðŸŽ¨ Checking code formatting..."
        black --check mlops/ shadows/ || {
          echo "âš ï¸ Code formatting issues found - running auto-fix"
          black mlops/ shadows/
          echo "âœ… Auto-formatting applied"
        }

        echo "ðŸ”’ Running security scan..."
        bandit -r mlops/ shadows/ -f json || {
          echo "âš ï¸ Security issues found but continuing build"
        }
      continue-on-error: false

  lint-frontend:
    runs-on: ubuntu-latest
    name: Frontend Lint + Build
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
    with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Frontend Quality Check
    run: |
        cd frontend
        npm ci

        echo "ðŸ” Running frontend linting..."
        npm run lint || {
          echo "âš ï¸ Linting issues found - attempting auto-fix"
          npm run lint:fix || echo "Auto-fix completed with warnings"
        }

        echo "ðŸ—ï¸ Building frontend..."
        npm run build
      continue-on-error: false

  lint-yaml:
    runs-on: ubuntu-latest
    name: YAML Lint (Helm/CI)
    steps:
    - uses: actions/checkout@v4

    - name: YAML Quality Check
    run: |
        pip install yamllint

        echo "ðŸ” Running YAML linting..."
        yamllint helm/ .github/ || {
          echo "âš ï¸ YAML issues found - attempting auto-fix"
          python3 fix_yamllint.py || echo "YAML auto-fix completed"
          yamllint helm/ .github/ || echo "Some YAML issues remain but continuing"
        }
      continue-on-error: true

  helm-validate:
    runs-on: ubuntu-latest
    name: Helm Chart Lint + Update
    needs: [lint-yaml]
    if: always() && (needs.lint-yaml.result == 'success' || needs.lint-yaml.result == 'failure')
    steps:
    - uses: actions/checkout@v4

    - uses: azure/setup-helm@v3
    with:
        version: v3.12.0

    - name: Helm Validation
    run: |
        cd helm/linkops

        echo "ðŸ“¦ Updating Helm dependencies..."
        helm dependency update || {
          echo "âš ï¸ Dependency update failed - trying without cache"
          rm -rf charts/ Chart.lock
          helm dependency update || echo "Dependencies may be outdated"
        }

        echo "ðŸ” Linting Helm charts..."
        helm lint . || {
          echo "âš ï¸ Helm lint found issues but charts may still be deployable"
        }
      continue-on-error: true

  docker-build-push:
    runs-on: ubuntu-latest
    name: Build + Push Docker Images
    needs: [lint-python, lint-frontend, helm-validate]
    if: always() && github.ref == 'refs/heads/main' && (needs.lint-python.result == 'success' || needs.lint-python.result == 'failure')
    steps:
    - uses: actions/checkout@v4

    - uses: docker/setup-buildx-action@v3

    - uses: docker/login-action@v3
    with:
        username: ${{ secrets.DOCKER_USER }}
        password: ${{ secrets.DOCKER_CRED }}
      continue-on-error: false

    - name: Build + Push all services
    run: |
        success_count=0
        total_count=0

        for dir in mlops/* shadows/*; do
          if [-f "$dir/Dockerfile"]; then
            name=$(basename $dir)
            total_count=$((total_count + 1))
            echo "ðŸ—ï¸ Building $name..."

            if docker build -t linkops/$name:latest $dir; then
              echo "âœ… Build successful for $name"
              if docker push linkops/$name:latest; then
                echo "âœ… Push successful for $name"
                success_count=$((success_count + 1))
              else
                echo "âŒ Push failed for $name"
              fi
            else
              echo "âŒ Build failed for $name"
            fi
          fi
        done

        echo "ðŸ“Š Build Summary: $success_count/$total_count services built successfully"

        # Continue if at least 50% of services built successfully
        if [$success_count -gt 0] && [$((success_count * 2)) -ge $total_count]; then
          echo "âœ… Sufficient services built successfully"
        else
          echo "âŒ Too many build failures"
          exit 1
        fi
      continue-on-error: false

  trivy-scan:
    runs-on: ubuntu-latest
    name: Trivy Security Scan
    steps:
    - uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
    uses: aquasecurity/trivy-action@0.32.0
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
      continue-on-error: true

    - name: Upload Trivy scan results
    uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'
      continue-on-error: true

  gitguardian:
    runs-on: ubuntu-latest
    name: GitGuardian Secret Scan
    steps:
    - uses: actions/checkout@v4

    - name: Run GitGuardian
    uses: GitGuardian/ggshield-action@v1.25.0
      env:
        GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
      continue-on-error: true

  update-argocd:
    runs-on: ubuntu-latest
    name: Update ArgoCD Pull Config
    needs: [docker-build-push]
    if: always() && github.ref == 'refs/heads/main' && (needs.docker-build-push.result == 'success' || needs.docker-build-push.result == 'failure')
    steps:
    - uses: actions/checkout@v4
    with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Update ArgoCD sync trigger
    run: |
        if [-f "helm/argocd/application.yaml"]; then
          echo "# Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> helm/argocd/application.yaml
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          git add helm/argocd/application.yaml
          git commit -m "chore: trigger ArgoCD sync - $(date -u +"%Y-%m-%d %H:%M:%S")" || echo "No changes to commit"
          git push || echo "No push needed"
        else
          echo "ArgoCD application.yaml not found, skipping sync trigger"
        fi
      continue-on-error: true

  notify-status:
    runs-on: ubuntu-latest
    name: Build Status Notification
    needs: [lint-python, lint-frontend, lint-yaml, helm-validate, docker-build-push, trivy-scan, gitguardian, update-argocd]
    if: always()
    steps:
    - name: Determine overall status
    run: |
        echo "ðŸ“Š Pipeline Status Summary:"
        echo "=========================="
        echo "Python Lint: ${{ needs.lint-python.result }}"
        echo "Frontend Lint: ${{ needs.lint-frontend.result }}"
        echo "YAML Lint: ${{ needs.lint-yaml.result }}"
        echo "Helm Validate: ${{ needs.helm-validate.result }}"
        echo "Docker Build: ${{ needs.docker-build-push.result }}"
        echo "Trivy Scan: ${{ needs.trivy-scan.result }}"
        echo "GitGuardian: ${{ needs.gitguardian.result }}"
        echo "ArgoCD Update: ${{ needs.update-argocd.result }}"

        # Determine if critical jobs passed
        critical_jobs=("lint-python" "lint-frontend" "docker-build-push")
        failed_critical=0

        if ["${{ needs.lint-python.result }}" != "success"]; then
          failed_critical=$((failed_critical + 1))
        fi
        if ["${{ needs.lint-frontend.result }}" != "success"]; then
          failed_critical=$((failed_critical + 1))
        fi
        if ["${{ needs.docker-build-push.result }}" != "success"] && ["${{ github.ref }}" == "refs/heads/main"]; then
          failed_critical=$((failed_critical + 1))
        fi

        if [$failed_critical -eq 0]; then
          echo "âœ… Pipeline completed successfully!"
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ Pipeline completed with $failed_critical critical job(s) failing"
          echo "status=partial" >> $GITHUB_OUTPUT
        fi
